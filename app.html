<!-- FINAL VERSION: WITH SLIDE NAVIGATION, NO HEADER, LOGOUT AT BOTTOM, MOBILE-FRIENDLY -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24/7 Spin Lucky Draw — Fun Coins</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script>
        function sendDataToKodular(data) {
            if (window.KodularWebview) {
                window.KodularWebview.PostMessage(JSON.stringify(data));
            } else {
                console.log("Kodular को मैसेज भेजा (टेस्टिंग):", data);
            }
        }

        function grantAdReward(amount) {
            if (currentUser && db) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.update({
                    coins: firebase.firestore.FieldValue.increment(amount)
                }).then(() => {
                    addTxn(currentUser.uid, 'Ad Reward', amount, 'Watched a rewarded ad', 'Success');
                    alert(`आपको इनाम में ${amount} सिक्के मिले हैं!`);
                });
            }
        }
    </script>

    <style>
        :root {
            --background-dark: #f5f7fa;
            --background-light: #FFFFFF;
            --primary-accent: #2c3e50;
            --secondary-accent: #18bc9c;
            --text-color: #2c3e50;
            --text-muted: #7f8c8d;
            --gold-accent: #f39c12;
            --success-color: #18bc9c;
            --danger-color: #e74c3c;
            --border-color: #e4e7ea;
        }

        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-dark);
            color: var(--text-color);
            text-align: center;
        }

        .header-bar {
            background-color: var(--background-light);
            padding: 10px 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .open-nav-btn {
            font-size: 22px;
            cursor: pointer;
            color: var(--text-color);
            font-weight: 600;
            flex: 1;
            text-align: left;
        }
        
        #headerWalletBalance {
            flex: 2;
            text-align: center;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }
        #headerWalletBalance::before {
            content: ''; display: inline-block; width: 20px; height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%23f39c12' stroke='%23d35400' stroke-width='2'/%3E%3Ctext x='12' y='17' font-family='Arial, sans-serif' font-size='14' font-weight='bold' text-anchor='middle' fill='%23d35400'%3E¢%3C/text%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; flex-shrink: 0;
        }

        .header-placeholder {
            flex: 1;
        }

        .sidenav {
            height: 100%; width: 0; position: fixed; z-index: 2000; top: 0; left: 0;
            background-color: var(--background-light); overflow-x: hidden; transition: 0.4s;
            padding-top: 60px; box-shadow: 3px 0 15px rgba(0,0,0,0.1); border-right: 1px solid var(--border-color);
        }
        .sidenav a { padding: 12px 15px 12px 20px; text-decoration: none; font-size: 16px; color: var(--text-color); display: block; transition: 0.2s; text-align: left; }
        .sidenav a:hover { background-color: #f1f1f1; }
        .sidenav .closebtn { position: absolute; top: 10px; right: 20px; font-size: 36px; color: var(--text-muted); }
        .sidenav .user-profile { padding: 20px; text-align: left; background: var(--primary-accent); color: white; border-bottom: 2px solid var(--gold-accent); }
        .sidenav .user-profile h4 { margin: 0; font-size: 18px; font-weight: 700; }
        .sidenav .user-profile p { margin: 5px 0 0 0; font-size: 14px; }

        #overlay {
            position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); z-index: 1999; transition: 0.4s;
        }
        
        .wallet-box, .join-box, .prize-pool, .purchases-box, .auth-wrap, .modal-content, #join-contest-wrapper {
            margin: 10px auto;
            padding: 12px; width: 90%; max-width: 450px; border-radius: 12px;
            background: var(--background-light); box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid var(--border-color);
        }
        
        .modal-content { 
            padding: 25px; 
            position: relative;
        }
        #join-contest-wrapper { padding: 0; }
        #join-contest-wrapper .join-box { padding: 12px; }

        .wallet-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
        .wallet-buttons button { padding: 7px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #FFFFFF; transition: all 0.2s ease-in-out; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .wallet-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); opacity: 0.9; }
        .add-btn { background: var(--success-color); }
        .history-btn { background: var(--text-muted); }
        .my-ticket-btn { background: var(--gold-accent); color: #fff; }
        .achievements-btn { background: #9b59b6; }
        .scratch-card-btn { background: #e67e22; }
        .mission-btn { background: #3498db; }
        .store-btn { background: var(--secondary-accent); }

        .wheel-container { margin: 10px auto; position: relative; width: 65vw; height: 65vw; max-width: 240px; max-height: 240px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 5px solid var(--background-light); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid var(--primary-accent); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        
        .join-box { font-size: 13px; margin: 0; }
        .join-box > div:first-of-type { font-weight: 600; margin-bottom: 5px; }
        .join-box .progress-bar-container { margin: 5px 0; }
        .join-box .counts-container { margin-bottom: 8px; font-size: 11px; }
        .join-box .choose-text { font-weight: bold; margin-bottom: 5px; font-size: 13px; }
        #myTicketBtn { padding: 6px; font-size: 12px; }
        
        .status-container { padding: 8px 12px; border-radius: 12px 12px 0 0; background: var(--background-dark); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        #timerDisplay { font-size: 14px; font-weight: bold; color: var(--danger-color); }
        #statusText { font-size: 13px; font-weight: 600; color: var(--text-muted); }

        .logout-btn { background: var(--danger-color); color: #fff; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: all 0.2s ease-in-out; }
        .logout-btn:hover { opacity: 0.9; }
        .footer-logout-container { margin: 15px auto; width: 90%; max-width: 450px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
        #resultModal .modal-content { margin: 10% auto; padding: 25px; }
        #resultModal .modal-content { border-top: 4px solid var(--secondary-accent); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #resultModal h3 { color: var(--primary-accent); font-size: 24px; }
        #resultModal #resultText { font-size: 18px; line-height: 1.6; }
        #resultModal #resultText small { font-size: 14px; color: var(--text-muted); display: block; margin-top: 10px; }
        
        .auth-wrap { max-width: 420px; text-align: left; }
        .auth-tabs button { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #e9ecef; color: var(--text-color); cursor: pointer; font-weight: 600; }
        .auth-tabs button.active { background: var(--primary-accent); color: #fff; }
        .auth-form label { display: block; font-size: 14px; margin-top: 10px; color: var(--text-muted); }
        .auth-form input { width: 100%; padding: 10px; border: 1px solid var(--border-color); background-color: #f8f9fa; color: var(--text-color); border-radius: 8px; margin-top: 5px; box-sizing: border-box; }
        .auth-form .auth-btn { width: 100%; margin-top: 15px; background: var(--success-color); color: #fff; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 600; }
        
        .prize-pool { font-size: 13px; line-height: 1.7; text-align: center; }
        .prize-pool b { color: var(--primary-accent); }
        .purchases-box { height: 140px; overflow-y: auto; position: relative; }
        .purchase-item { padding: 6px 10px; font-size: 12px; border-bottom: 1px solid #eee; color: var(--text-muted); text-align: left; display: flex; align-items: center; }
        .purchase-item:last-child { border-bottom: none; }
        .purchase-item img { width: 30px; height: 30px; border-radius: 6px; margin-right: 10px; }
        .purchase-item b { color: var(--text-color); }
        .close { cursor: pointer; float: right; font-size: 28px; font-weight: bold; color: var(--text-muted); transition: color 0.2s; position: absolute; top: 10px; right: 15px; z-index: 10; }
        .close:hover { color: var(--text-color); }

        .xp-bar { background-color: #e9ecef; border-radius: 5px; height: 4px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-color); }
        .xp-bar-fill { background: var(--secondary-accent); height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        
        #numberGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 4px; margin-top: 8px; }
        .number-btn { padding: 5px; font-size: 12px; font-weight: bold; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; background-color: #f8f9fa; color: var(--text-color); transition: all 0.2s ease; }
        .number-btn:hover:not(:disabled) { background-color: #e2e6ea; border-color: #dae0e5; }
        .number-btn:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; }
        .number-btn.selected { background-color: var(--gold-accent); color: #fff; border-color: var(--gold-accent); }
        
        .store-item { border: 1px solid var(--border-color); background-color: #fff; }
        .buy-btn { background-color: var(--success-color); color: #fff; }
        .buy-btn:disabled { background-color: #6c757d; color: #fff; }
        #myTicketBtn { width: 100%; margin-bottom: 8px; }

        @media screen and (max-width: 400px) {
            body { -webkit-text-size-adjust: 100%; }
            .wallet-box, .join-box, .prize-pool, .purchases-box, #join-contest-wrapper { margin: 10px auto; padding: 10px; }
            .wallet-buttons button { font-size: 12px; padding: 6px 8px; }
            #numberGrid { gap: 4px; }
            .number-btn { font-size: 12px; padding: 5px; }
            .modal-content { margin: 10% auto; }
            .sidenav { padding-top: 50px; }
            .sidenav a { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div id="loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-dark); display: flex; justify-content: center; align-items: center; z-index: 9999; color: var(--text-color); font-size: 20px;">Loading...</div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="user-profile">
            <h4 id="navUsername">Welcome, User</h4>
            <p>Coins: <span id="navUserCoins">0</span></p>
        </div>
        <a href="#" onclick="openHistory(); closeNav();">📜 Activity History</a>
        <a href="#" onclick="openStore(); closeNav();">🛍️ In-Game Store</a>
        <a href="#" onclick="openMission(); closeNav();">🎯 Level Missions</a>
        <a href="#" onclick="openAchievements(); closeNav();">🏆 Achievements</a>
        <a href="#" onclick="openTerms(); closeNav();">📄 Terms & Privacy</a>
        <hr style="border-color: var(--border-color); margin: 10px 20px;">
        <a href="#" onclick="logout()">Logout</a>
    </div>
    <div id="overlay" onclick="closeNav()"></div>

    <section id="authSection" style="display:none;">
        <div class="auth-wrap"> <div class="auth-tabs"> <button id="tabLogin" class="active" onclick="showTab('login')">Login</button> <button id="tabSignup" onclick="showTab('signup')">Signup</button> </div> <div id="loginForm" class="auth-form"> <label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" /> <label>Password</label><input type="password" id="loginPassword" placeholder="Enter password" /> <button class="auth-btn" onclick="doLogin()">Login</button> </div> <div id="signupForm" class="auth-form" style="display:none;"> <label>Username</label><input type="text" id="signupUsername" placeholder="Choose a public username" /> <label>Email</label><input type="email" id="signupEmail" placeholder="you@example.com" /> <label>Password</label><input type="password" id="signupPassword" placeholder="Choose password" /> <button class="auth-btn" onclick="doSignup()">Create account</button> </div> <div style="text-align:center; margin-top: 20px; font-size: 14px;"><a href="#" onclick="openTerms()">Terms & Privacy</a></div> </div>
    </section>

    <section id="appSection" style="display:none;">
        <div class="header-bar">
            <span class="open-nav-btn" onclick="openNav()">&#9776;</span>
            <div id="headerWalletBalance">Wallet Coins:&nbsp;<span id="headerCoinCount">0</span></div>
            <div class="header-placeholder"></div>
        </div>
        
        <div class="wallet-box"> 
            <div class="level-info"> 
                <span id="levelDisplay">Level: 1</span> | <span id="xpDisplay">XP: 0/100</span> 
                <div class="xp-bar"><div id="xpBarFill" class="xp-bar-fill"></div></div> 
            </div> 
            <div class="wallet-buttons"> 
                <button class="add-btn" onclick="sendDataToKodular({type: 'showRewardedAd', amount: 50})">Get Coins</button> 
                <button class="history-btn" onclick="openHistory()">History</button> <button class="achievements-btn" onclick="openAchievements()">Achievements</button> <button id="scratchCardBtn" class="scratch-card-btn" onclick="openScratchCard()">Daily Reward</button> <button class="mission-btn" onclick="openMission()">Level Missions</button> <button class="store-btn" onclick="openStore()">Store</button> </div> 
        </div> 
        
        <div class="wheel-container"><canvas id="wheel" width="240" height="240"></canvas><div class="pointer"></div></div> 
        
        <div id="main-page-contest-area"></div>
        
        <div id="prizePool" class="prize-pool"></div> 
        <div style="font-size:14px; font-weight:bold; margin-top:15px;">Recent Purchases</div> 
        <div class="purchases-box"><div id="purchaseList"></div></div> 
        <div class="footer-logout-container"> <button class="logout-btn" onclick="logout()">Logout</button> </div>
    </section>

    <div id="join-contest-wrapper">
        <div class="status-container">
            <div id="timerDisplay">Next Spin In: 30s</div>
            <span id="statusText"></span>
        </div>
        <div class="join-box"> 
            <div>24 Members Contest (Join Fee: 5 Coins)</div> 
            <div class="progress-bar-container" style="position:relative;height:4px;background:#e9ecef;border-radius:3px;overflow:hidden;"> 
                <div id="joinFill" style="height:100%;background:linear-gradient(90deg,#28a745,#218838);border-radius:3px;width:0%; transition: width 1s linear;"></div> 
            </div> 
            <div class="counts-container" style="display:flex;justify-content:space-between;color:var(--text-muted)"> 
                <span id="joinedCount">0 Joined</span>
                <span id="spotsLeft">24 Spots Left</span> 
            </div> 
            <div class="choose-text">Choose Your Lucky Number:</div> 
            <button id="myTicketBtn" class="my-ticket-btn" style="width: 100%;">My Tickets: -</button> 
            <div id="numberGrid"></div> 
            <div style="font-size:11px;color:#666;margin-top:8px">Note: Coins are virtual and cannot be exchanged for money. For entertainment only.</div> 
        </div>
    </div>

    <!-- Modals -->
    <div id="resultModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('resultModal')">×</span><h3>Spin Result</h3><p id="resultText"></p></div></div>
    <div id="historyModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('historyModal')">×</span><h3>Activity History</h3><div id="historyList" style="max-height:200px;overflow-y:auto;text-align:left;font-size:13px"></div></div></div>
    <div id="termsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('termsModal')">×</span><h3>Terms & Privacy</h3><div style="text-align:left;font-size:13px"><p>This app uses virtual coins for in-game participation. Coins are non-transferable and cannot be redeemed for real money.</p><p>This app is for entertainment only and does not involve real money gambling.</p></div></div></div>
    <div id="dailyBonusModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('dailyBonusModal')">×</span><h3>Daily Login Bonus!</h3><p id="dailyBonusText"></p></div></div>
    <div id="achievementsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('achievementsModal')">×</span><h3>Achievements</h3><div id="achievementsList"></div></div></div>
    <div id="scratchCardModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('scratchCardModal')">×</span> <h3>Daily Scratch Card</h3> <div class="scratch-card-container"> <div id="prize-text"></div> <canvas id="scratchCanvas" width="300" height="150"></canvas> </div> <div id="scratch-message">Scratch here to reveal your prize!</div> </div> </div>
    <div id="missionModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('missionModal')">×</span> <h3>Level Missions</h3> <div id="missionList"></div> </div> </div>
    <div id="storeModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('storeModal')">×</span> <h3>In-Game Store</h3> <div id="storeList" style="max-height: 300px; overflow-y: auto;"></div> </div> </div>

    <script>
        const firebaseConfig = {
           apiKey: "AIzaSyCSRrZXBlbA9sJ8sTvp0lthjvaqb1PetAA",
           authDomain: "spingame-128e4.firebaseapp.com",
           databaseURL: "https://spingame-128e4-default-rtdb.firebaseio.com",
           projectId: "spingame-128e4",
           storageBucket: "spingame-128e4.appspot.com",
           messagingSenderId: "949432242610",
           appId: "1:949432242610:web:27b223e1a210f024d514ab",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.enablePersistence().catch(err => {
            if (err.code == 'failed-precondition') { console.warn("Multiple tabs open..."); }
            else if (err.code == 'unimplemented') { console.warn("Browser doesn't support persistence."); }
        });
        const auth = firebase.auth();
        let currentUser = null, coins = 0, userTickets = [];
        let userProfile = { level: 1, xp: 0, joinCount: 0, achievements: [], claimedMissions: [] };
        let userUnsubscribe = null;
        let purchasesUnsubscribe = null;
        let appInitialized = false;

        // CAMBIO: काउंटर जोड़ा गया
        let spinCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            displayPrizePool();
            const contestWrapper = document.getElementById('join-contest-wrapper');
            const mainPageTarget = document.getElementById('main-page-contest-area');
            mainPageTarget.appendChild(contestWrapper);
        });

        auth.onAuthStateChanged(user => {
            document.getElementById('loader').style.display = 'none';
            if (user) {
                currentUser = user;
                document.getElementById("authSection").style.display = "none";
                document.getElementById("appSection").style.display = "block";
                initAppForUser();
            } else {
                currentUser = null;
                if (userUnsubscribe) userUnsubscribe();
                if (purchasesUnsubscribe) purchasesUnsubscribe();
                appInitialized = false;
                clearInterval(countdownInterval);
                document.getElementById("authSection").style.display = "block";
                document.getElementById("appSection").style.display = "none";
                showTab('login');
            }
        });

        function initAppForUser() {
            if (!currentUser || appInitialized) return;
            const userRef = db.collection("users").doc(currentUser.uid);
            userUnsubscribe = userRef.onSnapshot(doc => {
                if (!doc.exists) return;
                const data = doc.data();
                coins = data.coins || 0;
                userProfile = {
                    username: data.username || 'User',
                    level: data.level || 1, xp: data.xp || 0, joinCount: data.joinCount || 0,
                    achievements: data.achievements || [],
                    claimedMissions: data.claimedMissions || [],
                    inventory: data.inventory || []
                };
                updateCoinsDisplay();
                updateLevelDisplay();
                document.getElementById('navUsername').innerText = `Welcome, ${userProfile.username}`;
                document.getElementById('navUserCoins').innerText = coins;
            }, error => {
                console.error("Error fetching user data:", error);
            });
            checkDailyLogin();
            if (!appInitialized) {
                appInitialized = true;
                listenForRecentPurchases(); 
                startNewRound(); 
                drawWheel(true);
            }
        }
        
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("overlay").style.display = "block";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("overlay").style.display = "none";
        }
        
        function updateCoinsDisplay(){
            const headerCoinCount = document.getElementById("headerCoinCount");
            if (headerCoinCount) {
                headerCoinCount.innerText = coins;
            }
            document.getElementById('navUserCoins').innerText = coins;
        }

        const maxJoin=24;
        const wheelCanvas=document.getElementById("wheel"),wheelCtx=wheelCanvas.getContext("2d");
        const numSegments=24;
        const segmentAngle=2*Math.PI/numSegments;
        let currentAngle=0;
        const prizeMap={1:25,2:15,3:15,4:8,5:7,6:6,7:5,8:4,9:4,10:4,11:3,12:3,13:3,14:3,15:3,16:2,17:2,18:2,19:2,20:2, 21:2, 22:2, 23:2, 24:2};
        const totalPrizePool=Object.values(prizeMap).reduce((s,v)=>s+v,0);
        const ROUND_DURATION=30;let timeLeft=ROUND_DURATION;let countdownInterval=null;let isSpinning=false;let allParticipantsInRound={};let scratchCardClaimed=true;let randomPrize=0;const scratchCanvas=document.getElementById('scratchCanvas'),scratchCtx=scratchCanvas.getContext('2d');let isDrawing=false;
        
        function displayPrizePool(){const e=document.getElementById("prizePool");e.innerHTML=`<b>Prize Pool: ${totalPrizePool}</b> <br>Rank 1: ${prizeMap[1]} coins <br>Rank 2-3: ${prizeMap[2]} coins <br>Rank 4-24: ${prizeMap[4]}+ coins <br><small>Coins are virtual.</small>`}
        
        function startNewRound(){
            isSpinning=false; timeLeft=30; allParticipantsInRound={}; userTickets=[];
            document.getElementById("statusText").innerText = "Waiting for spin...";
            document.getElementById("joinFill").style.width="0%";
            updateJoinedCountDisplay(); clearInterval(countdownInterval); countdownInterval=setInterval(tick,1e3); tick();
        }
        
        function triggerSpin(){ isSpinning=true; clearInterval(countdownInterval); document.querySelectorAll(".number-btn").forEach(btn => btn.disabled = true); spinWheel(); }

        function stopRotateWheel(){
            clearTimeout(spinTimeoutId);
            const finalAngle=currentAngle*180/Math.PI%360;
            const correctedAngle=(360-finalAngle+270)%360;
            const winningSegment=Math.floor(correctedAngle / (360 / numSegments));
            const winningNumber=winningSegment+1;
            
            let ranks={}; let assignedNumbers=[];
            ranks[winningNumber]={rank:1,prize:prizeMap[1]}; assignedNumbers.push(winningNumber);
            const rank2Number = winningNumber === 1 ? numSegments : winningNumber - 1;
            ranks[rank2Number]={rank:2,prize:prizeMap[2]}; assignedNumbers.push(rank2Number);
            const rank3Number = winningNumber === numSegments ? 1 : winningNumber + 1;
            ranks[rank3Number]={rank:3,prize:prizeMap[3]}; assignedNumbers.push(rank3Number);

            let currentRank=4;
            for(let i=1; i<=numSegments; i++){
                if(!assignedNumbers.includes(i)){
                    if(prizeMap[currentRank]) {
                         ranks[i]={rank:currentRank, prize:prizeMap[currentRank]};
                    } else {
                         ranks[i]={rank:currentRank, prize:prizeMap[16]};
                    }
                    currentRank++;
                }
            }

            let totalWinnings=0; let prizeDetails=[];
            userTickets.forEach(ticket=>{
                if(ranks[ticket]){
                    totalWinnings+=ranks[ticket].prize;
                    prizeDetails.push(`Number #${ticket} won Rank ${ranks[ticket].rank} (${ranks[ticket].prize} coins)`);
                }
            });
            
            let resultMessage = '';
            if (totalWinnings > 0) {
                db.collection("users").doc(currentUser.uid).update({coins:firebase.firestore.FieldValue.increment(totalWinnings)}).then(()=>addTxn(currentUser.uid,"Contest Reward",totalWinnings,`Won with numbers. Rank1: #${winningNumber}`,"Success"));
                resultMessage = `🎉 You won ${totalWinnings} coins!<br><small>${prizeDetails.join("<br> ")}</small>`;
            } else {
                resultMessage = `Spin Finished! Top winners:<br><small><b>Rank 1:</b> Number #${winningNumber} wins ${prizeMap[1]} coins</small><br><small><b>Rank 2:</b> Number #${rank2Number} wins ${prizeMap[2]} coins</small><br><small><b>Rank 3:</b> Number #${rank3Number} wins ${prizeMap[3]} coins</small>`;
            }
            document.getElementById('resultText').innerHTML = resultMessage; openModal('resultModal');
            
            // CAMBIO: अब विज्ञापन हर 5 स्पिन के बाद दिखेगा
            spinCount++;
            if (spinCount % 5 === 0) {
                sendDataToKodular({type: 'showInterstitial'});
            }

            setTimeout(() => { closeModal('resultModal'); startNewRound(); }, 7500);
        }

        function listenForRecentPurchases(){
            const list = document.getElementById("purchaseList"); 
            purchasesUnsubscribe = db.collection("purchases").orderBy("timestamp","desc").limit(20).onSnapshot(snapshot => {
                if(snapshot.empty){
                    list.innerHTML = `<div class="purchase-item">No recent purchases yet.</div>`;
                    return;
                }
                list.innerHTML = '';
                snapshot.forEach(doc=>{
                    const data = doc.data();
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "purchase-item";
                    const userName = data.username ? data.username.substring(0,3)+"***" : "User***";
                    itemDiv.innerHTML = `<img src="${data.itemImage}" alt="${data.itemName}"> <span><b>${userName}</b> just bought a ${data.itemName}!</span>`;
                    list.appendChild(itemDiv);
                });
            }, err => {
                list.innerHTML = `<div class="purchase-item">Could not load purchases.</div>`;
                console.error("Purchase Load Error: ", err, "---> CHECK FIRESTORE INDEX AND SECURITY RULES for the 'purchases' collection.");
            });
        }
        
        async function buyItem(itemId, price, itemName, itemImage) { 
            if (coins < price) return alert('You do not have enough coins.'); 
            if (!confirm(`Are you sure you want to spend ${price} coins on a ${itemName}?`)) return; 
            const userRef = db.collection("users").doc(currentUser.uid); 
            const purchaseRef = db.collection("purchases"); 
            try { 
                await userRef.update({ coins: firebase.firestore.FieldValue.increment(-price), inventory: firebase.firestore.FieldValue.arrayUnion(itemId) }); 
                await purchaseRef.add({ userId: currentUser.uid, username: userProfile.username, itemName: itemName, itemImage: itemImage, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                await addTxn(currentUser.uid, 'Store Purchase', price, `Bought ${itemName}`, 'Success'); 
                alert('Purchase successful!'); 
                openStore();
            } catch (error) { 
                console.error("Purchase error: ", error); alert('Something went wrong.'); 
            } 
        }

        function closeModal(modalId){ document.getElementById(modalId).style.display="none"; }
        
        const wheelColors = ['#3498db', '#1abc9c', '#9b59b6', '#e67e22', '#2ecc71', '#f1c40f', '#e74c3c', '#2c3e50'];

        function drawWheel(initial = false){
            const canvas = wheelCanvas; const ctx = wheelCtx;
            if (initial) { const containerSize = document.querySelector('.wheel-container').offsetWidth; canvas.width = containerSize; canvas.height = containerSize; }
            const size = canvas.width; const center = size / 2; const radius = center - (size * 0.02);
            ctx.clearRect(0,0,size,size);
            for(let e=0;e<numSegments;e++) {
                ctx.beginPath(); ctx.moveTo(center,center); ctx.arc(center,center,radius,currentAngle+e*segmentAngle,currentAngle+(e+1)*segmentAngle);
                ctx.fillStyle = wheelColors[e % wheelColors.length];
                ctx.fill(); ctx.save(); ctx.translate(center,center);
                ctx.rotate(currentAngle+e*segmentAngle+segmentAngle/2); ctx.textAlign="right"; 
                ctx.fillStyle = '#FFFFFF';
                ctx.font=`${size * 0.05}px Poppins`; ctx.fillText(e+1, radius - (size * 0.05) , 5); ctx.restore();
            }
        }
        function updateJoinedCountDisplay(){ 
            const joinedCount = Object.keys(allParticipantsInRound).length; 
            document.getElementById("joinedCount").innerText = `${joinedCount} Joined`; 
            document.getElementById("spotsLeft").innerText = `${maxJoin - joinedCount} Spots Left`; 
            document.getElementById("myTicketBtn").innerText = userTickets.length > 0 ? `My Numbers: ${userTickets.sort((a, b) => a - b).join(', ')}` : 'My Tickets: -'; 
            const grid = document.getElementById('numberGrid'); grid.innerHTML = ''; 
            for (let i = 1; i <= numSegments; i++) { 
                const button = document.createElement('button'); button.innerText = i; button.className = 'number-btn'; 
                button.onclick = () => selectNumber(i); 
                if (i in allParticipantsInRound) button.disabled = true; 
                if (userTickets.includes(i)) button.classList.add('selected'); 
                grid.appendChild(button); 
            } 
        }
        function openModal(e){document.getElementById(e).style.display="block"}
        function tick(){if(timeLeft>=0){document.getElementById("timerDisplay").innerText=`Next Spin In: ${timeLeft}s`,document.getElementById("joinFill").style.width=`${(30-timeLeft)/30*100}%`,0===timeLeft&&triggerSpin(),timeLeft--} else {clearInterval(countdownInterval)}}
        async function checkDailyLogin() { const userRef = db.collection("users").doc(currentUser.uid); try { const doc = await userRef.get(); if (!doc.exists) return; const data = doc.data(); const today = new Date().setHours(0, 0, 0, 0); const lastLoginDate = data.lastLogin ? new Date(data.lastLogin.toDate()).setHours(0, 0, 0, 0) : null; if (lastLoginDate !== today) { const bonus = 25; await userRef.update({ coins: firebase.firestore.FieldValue.increment(bonus), lastLogin: firebase.firestore.FieldValue.serverTimestamp() }); await addTxn(currentUser.uid, 'Daily Bonus', bonus, 'Daily login reward', 'Success'); document.getElementById('dailyBonusText').innerText = `You received ${bonus} coins as your daily login bonus!`; openModal('dailyBonusModal'); } checkScratchCardStatus(data.lastScratchTime); } catch (error) { console.error("Error in checkDailyLogin:", error); } }
        async function earnCoins() { if (!currentUser) return alert("Login first."); const userRef = db.collection("users").doc(currentUser.uid); const now = new Date(); const oneHour = 60 * 60 * 1000; try { const doc = await userRef.get(); const lastClaimTime = doc.data().lastClaimedGetCoins ? doc.data().lastClaimedGetCoins.toDate() : null; if (lastClaimTime && (now.getTime() - lastClaimTime.getTime() < oneHour)) { const timeLeft = oneHour - (now.getTime() - lastClaimTime.getTime()); const minutesLeft = Math.ceil(timeLeft / (60 * 1000)); return alert(`Please wait. You can claim again in about ${minutesLeft} minutes.`); } const coinsToGive = 20; await userRef.update({ coins: firebase.firestore.FieldValue.increment(coinsToGive), lastClaimedGetCoins: firebase.firestore.FieldValue.serverTimestamp() }); await addTxn(currentUser.uid, 'Get Coins', coinsToGive, 'Hourly bonus', 'Success'); alert(`${coinsToGive} coins have been added to your wallet!`); } catch (error) { console.error("Error adding coins: ", error); alert("Could not add coins. Error: " + error.message); } }
        function checkScratchCardStatus(e){const t=(new Date).setHours(0,0,0,0),a=e?new Date(e.toDate()).setHours(0,0,0,0):null,n=document.getElementById("scratchCardBtn");a===t?(scratchCardClaimed=true,n.disabled=true,n.innerText="Claimed Today"):(scratchCardClaimed=false,n.disabled=false,n.innerText="Daily Reward")}
        function openScratchCard(){if(scratchCardClaimed)return alert("You have already claimed your daily reward. Come back tomorrow!");setupScratchCard(),openModal("scratchCardModal")}
        function setupScratchCard(){const e=[5,10,15,25,50];randomPrize=e[Math.floor(Math.random()*e.length)];const t=document.getElementById("prize-text"),a=document.getElementById("scratchCanvas");t.innerHTML="",a.style.display="block",scratchCtx.globalCompositeOperation="source-over",scratchCtx.clearRect(0,0,scratchCanvas.width,scratchCanvas.height);const n=scratchCtx.createLinearGradient(0,0,scratchCanvas.width,0);n.addColorStop(0,"#bbbbbb"),n.addColorStop(.5,"#999999"),n.addColorStop(1,"#bbbbbb"),scratchCtx.fillStyle=n,scratchCtx.fillRect(0,0,scratchCanvas.width,scratchCanvas.height),document.getElementById("scratch-message").innerText="Scratch here to reveal your prize!"}
        function getScratchPos(e,t){const a=e.getBoundingClientRect(),n=e.width/a.width,r=e.height/a.height,c=t.touches?t.touches[0].clientX:t.clientX,o=t.touches?t.touches[0].clientY:t.clientY;return{x:(c-a.left)*n,y:(o-a.top)*r}}
        function scratch(e){if(!isDrawing||scratchCardClaimed)return;e.preventDefault();const t=getScratchPos(scratchCanvas,e);scratchCtx.globalCompositeOperation="destination-out",scratchCtx.beginPath(),scratchCtx.arc(t.x,t.y,20,0,2*Math.PI),scratchCtx.fill()}
        function checkScratchProgress(){if(scratchCardClaimed)return;const e=scratchCtx.getImageData(0,0,scratchCanvas.width,scratchCanvas.height).data;let t=0;for(let a=3;a<e.length;a+=4)e[a]<128&&t++;t/(e.length/4)*100>60&&claimScratchPrize()}
        function claimScratchPrize(){if(scratchCardClaimed)return;scratchCardClaimed=true,isDrawing=false,document.getElementById("scratchCanvas").style.display="none";const e=document.getElementById("prize-text");e.innerHTML=`<div class="prize-icon"></div><div class="win-text">You've won</div><div class="prize-amount">${randomPrize} Coins</div>`,db.collection("users").doc(currentUser.uid).update({coins:firebase.firestore.FieldValue.increment(randomPrize),lastScratchTime:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{addTxn(currentUser.uid,"Scratch Reward",randomPrize,"Daily scratch card win","Success");const e=document.getElementById("scratchCardBtn");e.disabled=true,e.innerText="Claimed Today",document.getElementById("scratch-message").innerHTML=`🎉 <b>Congratulations!</b> ${randomPrize} coins have been added to your wallet.`})}
        scratchCanvas.addEventListener("mousedown",e=>{isDrawing=true,scratch(e)}),scratchCanvas.addEventListener("touchstart",e=>{isDrawing=true,scratch(e)},{passive:false}),scratchCanvas.addEventListener("mousemove",scratch),scratchCanvas.addEventListener("touchmove",scratch,{passive:false}),scratchCanvas.addEventListener("mouseup",()=>{isDrawing&&(isDrawing=false,checkScratchProgress())}),scratchCanvas.addEventListener("touchend",()=>{isDrawing&&(isDrawing=false,checkScratchProgress())}),scratchCanvas.addEventListener("mouseleave",()=>{isDrawing&&(isDrawing=false,checkScratchProgress())});
        function getXPForNextLevel(e){return 100*Math.pow(e,1.5)}
        function addXP(e){userProfile.xp+=e;const t=getXPForNextLevel(userProfile.level);if(userProfile.xp>=t){userProfile.level++,userProfile.xp-=t;const a=50*userProfile.level;db.collection("users").doc(currentUser.uid).update({coins:firebase.firestore.FieldValue.increment(a)}),addTxn(currentUser.uid,"Level Up Bonus",a,`Reached Level ${userProfile.level}`,"Success"),alert(`Congratulations! You reached Level ${userProfile.level} and received ${a} coins!`),checkAchievements()}db.collection("users").doc(currentUser.uid).update({xp:userProfile.xp,level:userProfile.level}),updateLevelDisplay()}
        function updateLevelDisplay(){const e=getXPForNextLevel(userProfile.level);document.getElementById("levelDisplay").innerText=`Level: ${userProfile.level}`,document.getElementById("xpDisplay").innerText=`XP: ${Math.floor(userProfile.xp)}/${Math.floor(e)}`,document.getElementById("xpBarFill").style.width=`${userProfile.xp/e*100}%`}
        const ALL_ACHIEVEMENTS={join10:{title:"Beginner Spinner",description:"Join the contest 10 times."},level5:{title:"Apprentice",description:"Reach Level 5."},win500:{title:"Coin Collector",description:"Win over 500 coins in total."}};function checkAchievements(){userProfile.joinCount>=10&&!userProfile.achievements.includes("join10")&&unlockAchievement("join10"),userProfile.level>=5&&!userProfile.achievements.includes("level5")&&unlockAchievement("level5")}
        function unlockAchievement(e){userProfile.achievements.push(e);const t=100;db.collection("users").doc(currentUser.uid).update({achievements:firebase.firestore.FieldValue.arrayUnion(e),coins:firebase.firestore.FieldValue.increment(t)}),addTxn(currentUser.uid,"Achievement",t,`Unlocked: ${ALL_ACHIEVEMENTS[e].title}`,"Success"),alert(`Achievement Unlocked: ${ALL_ACHIEVEMENTS[e].title}! You received ${t} coins.`)}
        function openAchievements(){const e=document.getElementById("achievementsList");e.innerHTML="";for(const t in ALL_ACHIEVEMENTS){const a=ALL_ACHIEVEMENTS[t],n=userProfile.achievements.includes(t),r=document.createElement("div");r.className=n?"achievement-item unlocked":"achievement-item",r.innerHTML=`<b>${a.title}</b><br><small>${a.description}</small>`,e.appendChild(r)}openModal("achievementsModal")}
        function selectNumber(number) { if(!currentUser) return alert("Please login first."); if(isSpinning) return; if (number in allParticipantsInRound) return alert("This number is already taken!"); if(userTickets.length >= 10) return alert("You can select a maximum of 10 numbers."); const joinFee = 5; if(coins < joinFee) return alert("Not enough coins. Each number costs " + joinFee + " coins."); db.collection("users").doc(currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(-joinFee), joinCount: firebase.firestore.FieldValue.increment(1) }).then(() => { allParticipantsInRound[number] = currentUser.uid; userTickets.push(number); addXP(10); checkAchievements(); addTxn(currentUser.uid, 'Join Contest', joinFee, `Selected number #${number}`, 'Success'); updateJoinedCountDisplay(); }).catch(error => { console.error("Error joining contest: ", error); alert("Could not join contest. Please try again."); }); }
        let spinTimeoutId=null;function spinWheel(){spinTimeoutId=setTimeout(()=>handleSpinFailure("Timeout"),16e3);let e=0,t=12e3;const a=10+5*Math.random(),n=360*a;function r(c){e||(e=c);const o=c-e;if(o>=t)return currentAngle=n*Math.PI/180,drawWheel(),void stopRotateWheel();const i=o/t,l=1-Math.pow(1-i,4);currentAngle=n*l*Math.PI/180,drawWheel(),requestAnimationFrame(r)}requestAnimationFrame(r)}
        function handleSpinFailure(e){clearTimeout(spinTimeoutId),alert("Spin issue: "+e+". Contest will reset."),startNewRound()}
        function doSignup(){const e=document.getElementById("signupUsername").value.trim(),t=document.getElementById("signupEmail").value.trim(),a=document.getElementById("signupPassword").value.trim();e&&t&&a?auth.createUserWithEmailAndPassword(t,a).then(a=>{db.collection("users").doc(a.user.uid).set({username:e,email:t,coins:100,lastLogin:firebase.firestore.FieldValue.serverTimestamp(),level:1,xp:0,joinCount:0,achievements:[],inventory: [], claimedMissions: []}).then(()=>{addTxn(a.user.uid,"Signup Bonus",100,"Welcome Bonus","Success"),alert("Account created! You received 100 coins as signup bonus.")})}).catch(e=>alert("Error: "+e.message)):alert("Please fill all fields.")}
        function doLogin(){const e=document.getElementById("loginEmail").value.trim(),t=document.getElementById("loginPassword").value.trim();e&&t?auth.signInWithEmailAndPassword(e,t).catch(e=>alert("Error: "+e.message)):alert("Enter email & password.")}
        function logout(){auth.signOut()}
        function showTab(e){document.getElementById("tabLogin").classList.toggle("active","login"===e),document.getElementById("tabSignup").classList.toggle("active","signup"===e),document.getElementById("loginForm").style.display="login"===e?"block":"none",document.getElementById("signupForm").style.display="signup"===e?"block":"none"}
        async function addTxn(e,t,a,n,r){try{await db.collection("transactions").add({userId:e,type:t,amount:parseFloat(a),details:n,status:r,timestamp:firebase.firestore.FieldValue.serverTimestamp()})}catch(c){console.error("Failed to add transaction:",c)}}
        async function openHistory(){if(!currentUser)return;openModal("historyModal");const e=document.getElementById("historyList");e.innerHTML="Loading...";try{const t=await db.collection("transactions").where("userId","==",currentUser.uid).orderBy("timestamp","desc").limit(50).get();if(e.innerHTML="",t.empty)return void(e.innerHTML="<p>No activity yet.</p>");t.forEach(t=>{const a=t.data(),n=a.timestamp&&a.timestamp.toDate?a.timestamp.toDate().toLocaleString():"N/A",r=document.createElement("div");r.style.cssText="border-bottom:1px solid #eee;padding:6px 0;",r.innerHTML=`<b>${a.type}</b> - ${a.amount} coins<br><small>${a.details} | ${n}</small>`,e.appendChild(r)})}catch(t){e.innerHTML="<p>Could not load history.</p>",console.error("History Error: ",t,"---> MOST LIKELY A MISSING FIRESTORE INDEX. Check the browser console for a link to create it.")}}
        function openTerms(){openModal('termsModal')}
        const levelMissions = { 5: { reward: 100, text: "Reach Level 5" }, 10: { reward: 250, text: "Reach Level 10" }, 15: { reward: 500, text: "Reach Level 15" }, 20: { reward: 1000, text: "Reach Level 20" } };
        function openMission() { const missionList = document.getElementById('missionList'); missionList.innerHTML = ''; for (const level in levelMissions) { const mission = levelMissions[level]; const isClaimed = userProfile.claimedMissions.includes(parseInt(level)); const canClaim = userProfile.level >= level && !isClaimed; const missionDiv = document.createElement('div'); missionDiv.className = 'achievement-item'; missionDiv.innerHTML = `<b>${mission.text}</b> - Reward: ${mission.reward} coins <button class="buy-btn" style="float: right;" onclick="claimMissionReward(${level})" ${!canClaim ? 'disabled' : ''}> ${isClaimed ? 'Claimed' : 'Claim'} </button>`; missionList.appendChild(missionDiv); } openModal('missionModal'); }
        async function claimMissionReward(level) { const mission = levelMissions[level]; if (!mission) return; const userRef = db.collection("users").doc(currentUser.uid); await userRef.update({ coins: firebase.firestore.FieldValue.increment(mission.reward), claimedMissions: firebase.firestore.FieldValue.arrayUnion(parseInt(level)) }); await addTxn(currentUser.uid, 'Mission Reward', mission.reward, `Completed: ${mission.text}`, 'Success'); alert(`Congratulations! You've claimed ${mission.reward} coins for reaching level ${level}!`); closeModal('missionModal'); }
        const storeItems = [ { id: 'mobile', name: 'Mobile Phone', price: 10000, image: 'https://via.placeholder.com/80/0000FF/FFFFFF?text=Mobile' }, { id: 'bike', name: 'Speedy Bike', price: 50000, image: 'https://via.placeholder.com/80/FF0000/FFFFFF?text=Bike' }, { id: 'car', name: 'Luxury Car', price: 200000, image: 'https://via.placeholder.com/80/000000/FFFFFF?text=Car' }, { id: 'tv', name: 'Big Screen TV', price: 25000, image: 'https://via.placeholder.com/80/333333/FFFFFF?text=TV' }, { id: 'fridge', name: 'Smart Fridge', price: 30000, image: 'https://via.placeholder.com/80/CCCCCC/000000?text=Fridge' }, { id: 'chair', name: 'Gaming Chair', price: 5000, image: 'https://via.placeholder.com/80/FFA500/FFFFFF?text=Chair' }, { id: 'table', name: 'Wooden Table', price: 7500, image: 'https://via.placeholder.com/80/A52A2A/FFFFFF?text=Table' } ];
        function openStore() { const storeList = document.getElementById('storeList'); storeList.innerHTML = ''; storeItems.forEach(item => { const itemOwned = userProfile.inventory && userProfile.inventory.includes(item.id); const itemDiv = document.createElement('div'); itemDiv.className = 'store-item'; itemDiv.innerHTML = `<img src="${item.image}" alt="${item.name}"> <div class="store-item-info"> <h4>${item.name}</h4> <p>Price: ${item.price} coins</p> <button class="buy-btn" id="buy-${item.id}" onclick="buyItem('${item.id}', ${item.price}, '${item.name}', '${item.image}')" ${itemOwned || coins < item.price ? 'disabled' : ''}> ${itemOwned ? 'Owned' : 'Buy'} </button> </div>`; storeList.appendChild(itemDiv); }); openModal('storeModal'); }
    </script>
</body>
</html>
